# 微服务之服务发现 #

假装大家都已经知道什么是微服务，那么我们先谈谈微服务架构中的一个重要组件——服务发现。


微服务架构中用于服务发现的主要有Consul、zookeeper、etcd、euerka。我们先做一个对比如下：
<https://github.com/Hanzhiwei210521/loading/blob/master/image/image005.png>

详细分析请见：<https://luyiisme.github.io/2017/04/22/spring-cloud-service-discovery-products/>

### zookeeper ###

Zookeeper是著名Hadooop的一个子项目，旨在解决大规模分布式应用场景下，服务协调同步的问题；它可以为同在一个分布式系统中的其他服务提供：统一命名服务、配置管理、集群管理、分布式锁服务等功能。

zookeeper数据结构如下：

<https://github.com/Hanzhiwei210521/loading/blob/master/image/image006.jpg>

* 统一命名服务（Name Service）

分布式应用中，通常需要有一套完整的命名规则，既能够产生唯一的名称又便于人识别和记住，通常情况下用树形的名称结构是一个理想的选择，树形的名称结构是一个有层次的目录结构，既对人友好又不会重复。说到这里你可能想到了JNDI，没错Zookeeper的Name Service与JNDI能够完成的功能是差不多的，它们都是将有层次的目录结构关联到一定资源上，但是Zookeeper的Name Service更加是广泛意义上的关联，也许你并不需要将名称关联到特定资源上，你可能只需要一个不会重复名称，就像数据库中产生一个唯一的数字主键一样。Name Service 已经是 Zookeeper 内置的功能，你只要调用 Zookeeper 的 API 就能实现。如调用 create 接口就可以很容易创建一个目录节点。

这么一段艰难晦涩的文字，其实本人并没有理解透彻，不过有一点需要补充，命名服务提供注册、注销和查看命名等接口，so，zookeeper作为注册中心，应该是通过该功能实现的吧。

* 配置管理（Configuration Management）

配置的管理在分布式应用环境中很常见，例如web集群都需要连接同一台redis、mysql、mq等，这些连接信息如果放在各个web服务器上，那维护起来就相当麻烦，而且容易出错。这时就需要一个统一配置管理。

像这样的配置信息完全可以交给Zookeeper来管理，将配置信息保存在Zookeeper的某个目录节点中，然后将所有需要修改的应用机器监控配置信息的状态，一旦配置信息发生变化，每台应用机器就会收到Zookeeper的通知，然后从Zookeeper获取新的配置信息应用的系统中。另外，我们还用过mysql做配置管理，将连接信息通过key-value存入MySQL的参数表中，然后web启动时先连接MySQL，读取参数表，然后获取其他连接信息，这样的弊端是每一台web都要存一个MySQL的连接信息。还有一种是基于spring cloud框架的统一配置管理，可以用git或svn实现。

配置管理结构图，如下：

<https://github.com/Hanzhiwei210521/loading/blob/master/image/image007.png>

* 集群管理（Group Membership）

Zookeeper 能够很容易的实现集群管理的功能，如有多台 Server 组成一个服务集群，那么必须要一个“总管”知道当前集群中每台机器的服务状态，一旦有机器不能提供服务，集群中其它集群必须知道，从而做出调整重新分配服务策略。同样当增加集群的服务能力时，就会增加一台或多台 Server，同样也必须让“总管”知道。

Zookeeper 不仅能够帮你维护当前的集群中机器的服务状态，而且能够帮你选出一个“总管”，让这个总管来管理集群，这就是 Zookeeper 的另一个功能 Leader Election。

* 共享锁（Locks）

共享锁在同一个进程中很容易实现，但是在跨进程或者在不同 Server 之间就不好实现了。Zookeeper 却很容易实现这个功能，实现方式也是需要获得锁的 Server 创建一个 EPHEMERAL_SEQUENTIAL 目录节点，然后调用 getChildren方法获取当前的目录节点列表中最小的目录节点是不是就是自己创建的目录节点，如果正是自己创建的，那么它就获得了这个锁，如果不是那么它就调用 exists(String path, boolean watch) 方法并监控 Zookeeper 上目录节点列表的变化，一直到自己创建的节点是列表中最小编号的目录节点，从而获得锁，释放锁很简单，只要删除前面它自己所创建的目录节点就行了。

文章参考自： <https://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper/>

